# Redux

We use [Redux](http://redux.js.org/docs/introduction/) to manage the global application state.

- [1. Stores](#1-stores)
  - [1.1. App](#1-1-app)
  - [1.2. API](#1-2-api)
  - [1.3. Document](#1-3-document)
  - [1.4. Documents](#1-4-documents)
  - [1.5. User](#1-5-user)
- [2. Actions](#2-actions)
  - [2.1. Dispatching](#2-1-dispatching)
  - [2.2. Asynchronous actions](#2-2-asynchronous-actions)

---

## 1. Stores

We have 5 stores that hold the state of different parts of the application.

### 1.1. App

Holds generic app-wide state

| Property        | Type     | Description                                                                                           | Initial state                                                 |
|--------------   |----------|-------------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
| `breakpoint`    | String   | Name of the current active breakpoint, as defined in the CSS files                                    | The name of the breakpoint that is active when the app starts |
| `config`        | Object   | Object containing the Publish configuration parameters that have been made available to the front-end | `null`                                                        |
| `networkStatus` | Constant | The status of the client internet connection and connection to the Publish server app                 | `NETWORK_OK`                                                  |
| `status`        | Constant | The status of the app, representing whether it's idle or loading                                      | `STATUS_IDLE`                                                 |

### 1.2. API

Holds state about APIs and collections.

| Property            | Type   | Description                                                                            | Initial state |
|---------------------|--------|----------------------------------------------------------------------------------------|---------------|
| `apis`              | Array  | List of all available APIs, including the schema for all their collections.            | `[]`          |
| `paths`             | Object | Document list, edit and create paths, generated by reading collection schemas          | `null`        |
| `status`            | String | The status of the api config data, representing whether it's idle, loading or erroing  | `STATUS_IDLE` |

### 1.3. Document

Holds the current active document (for document edit view)

| Property           | Type     | Description                                                                        | Initial state |
|--------------------|----------|------------------------------------------------------------------------------------|---------------|
| `local`            | Object   | The object representing the state of the document as it's being edited             | `null`        |
| `peers`            | Object   | Other users connected through socket and observing or editing the current document | `null`        |
| `remote`           | Object   | The object representing the state of the document in the remote API                | `null`        |
| `remoteStatus`     | Constant | The status of the document, representing whether it's idle, loading or erroing     | `STATUS_IDLE` |
| `saveAttempts`     | Number   | The number of times the user has attempted to save the current document.           | `0`           |
| `validationErrors` | Object   | Document field validation errors                                                   | `{}`          |

### 1.4. Documents

Holds the current list of documents (for document list view)

| Property | Type     | Description                                                                                                       | Initial state |
|----------|----------|-------------------------------------------------------------------------------------------------------------------|---------------|
| `list`   | Array    | The list of documents                                                                                             | `null`        |
| `query`  | String   | The current query parameters, used to distinguish between and empty collection and empty results based on a query | `null`        |
| `status` | Constant | The status of the document, representing whether it's idle, loading or erroing                                    | `STATUS_IDLE` |

### 1.5. User

Holds state about the current user

| Property  | Type     | Description                                                        | Initial state |
|-----------|----------|--------------------------------------------------------------------|---------------|
| `authEnabled`  | Boolean   | Whether this instance of Publish requires authentication    | `true/false`        |
| `failedSignInAttempts`  | Number   | The object of failed signed in attempts before the last successful one    | `0`        |
| `hasSignedOut`  | Boolean   | The user has signed out    | `false`        |
| `remote`  | Object   | The object representing the state of the user on the remote API    | `null`        |
| `resetEmail`  | String   | The recipient email address for a password reset    | `null`        |
| `resetError`  | String   | Errors returned when resetting a password    | `null`        |
| `resetSuccess`  | Boolean   | Password reset successfully sent    | `false`        |
| `status`  | Constant | The status of the user                                             | `STATUS_IDLE` |

## 2. Actions

Action creators are separated into different files within `frontend/actions`, depending on which part of the store they tend to change.

### 2.1. Dispatching

For convenience, we typically [bind the action creators](http://redux.js.org/docs/api/bindActionCreators.html) to the store's `dispatch` method, so we can simply run `action.doSomething()` instead of `dispatch(action.doSomething())`.

However, sometimes we need to have a finer control and have the need to call `dispatch()` manually, such as when dispatching multiple actions. Batching multiple actions within one dispatch is better than firing multiple bounded actions, as the latter will generate multiple re-renders of the components listening to the store.

*Example:*
```js
// We want to display a notification and clear the remote document
// at the same time, on a single change to the store, so we batch
// the two actions together.
dispatch(
  batchActions(
    actions.setNotification(notification),
    actions.clearRemoteDocument()
  )
)
```

### 2.2. Asynchronous actions

When we need to fetch data from a network or perform any other type of asynchronous operation, we use [asynchronous actions](http://redux.js.org/docs/advanced/AsyncActions.html). This allows a single action call to perform multiple changes to the store as events occur.

A perfect example of this is an API call to request data from the network. In this case, we want to update the store a few times:

1. Change the status to *loading* as the request begins;
2. If the request succeeds, update the store with the result and change the status to *idle*;
3. If the request fails, change the status to *failed*.

An asynchronous action can take care of all of this, leaving the calling containers with the sole task of dispatching a single action.

```js
// actions/documentActions.js
export function fetchDocument ({api, collection, id, fields}) {
  return (dispatch) => {
    const apiBridge = APIBridge(api)
      .in(collection)
      .whereFieldIsEqualTo('_id', id)

    if (fields) {
      apiBridge.useFields(fields)
    }

    // Set loading status
    dispatch(setRemoteDocumentStatus(Constants.STATUS_LOADING))

    apiBridge.find().then(response => {
      const document = response.results[0]

      dispatch(setRemoteDocument(document))
    }).catch(err => {
      dispatch(setRemoteDocumentStatus(Constants.STATUS_FAILED))
    })
  }
}
```
